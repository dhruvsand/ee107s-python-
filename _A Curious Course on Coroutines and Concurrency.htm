<!DOCTYPE html>
<!-- saved from url=(0033)http://www.dabeaz.com/coroutines/ -->
<html lang="en" class="gr__dabeaz_com"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>:A Curious Course on Coroutines and Concurrency</title>
    <!-- Required meta tags -->
    
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="./_A Curious Course on Coroutines and Concurrency_files/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">

<style type="text/css">
# a {text-decoration: none; }
# a.nav {color: #00ffff; }

.talk {
    clear: both;
    margin-bottom: 2em;
}

.talk h2 {
    line-height: 1.2;
}

.talk h3 {
    line-height: 1.2;
}

.talk h4 {
    line-height: 1.2;
}

.talk img {
   display: block;
   margin: 0 auto;
   max-width: 90%;
#   width: 240pt;
#   width: 30%;
   border: 2px solid black;
   box-shadow: 0.4em 0.5em 0.4em #888;
}

.course img {
   display: block;
   margin: 0 auto;
   max-width: 90%;
}

.coursepage img {
   display: block;
   max-width: 90%;
}

@media (max-width: 480pt) {
    .talk:before {
        display: block;
        margin: 1em auto;
        text-align: center;
        content: "<->";
    }
    .talk img {
        margin: 15pt;
    }
    .coursepage img {
        margin: 15pt;
    }
}

@media (min-width: 480pt) {
    body {
        padding-left: 2.5em;
        padding-right: 2.5em;
    }
    .talk img {
        float: left;
        max-width: 166pt;
    }
    .talk h2, .talk p, .talk h3, .talk h4 {
        padding-left: 192pt;
    }
    .coursepage img {
        max-width: 50%;
        float: left;
    }
}



</style>
  </head>
  <body data-gr-c-s-loaded="true" class="vsc-initialized">


<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <a class="navbar-brand" href="http://www.dabeaz.com/index.html">dabeaz</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">

  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="http://www.dabeaz.com/coroutines/#" role="button" aria-haspopup="true" aria-expanded="false">Teaching</a>
    <div class="dropdown-menu">
      <a class="dropdown-item" href="http://www.dabeaz.com/courses.html">Chicago Courses</a>
      <a class="dropdown-item" href="http://www.dabeaz.com/online.html">Online Courses</a>
      <a class="dropdown-item" href="http://www.dabeaz.com/teaching.html">On-site Python Training</a>
      <a class="dropdown-item" href="https://www.safaribooksonline.com/library/view/python-programming-language/9780134217314/">Python Programming (Video)</a>
    </div>
  </li>

  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="http://www.dabeaz.com/coroutines/#" role="button" aria-haspopup="true" aria-expanded="false">Writing</a>
    <div class="dropdown-menu">
      <a class="dropdown-item" href="http://www.dabeaz.com/per.html">Python Essential Reference</a>
      <a class="dropdown-item" href="http://www.dabeaz.com/cookbook.html">Python Cookbook</a>
      <a class="dropdown-item" href="http://www.dabeaz.com/usenix.html">Usenix :login;</a>
      <a class="dropdown-item" href="http://www.dabeaz.com/publications.html">Academic Publications</a>
    </div>
  </li>

  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="http://www.dabeaz.com/coroutines/#" role="button" aria-haspopup="true" aria-expanded="false">Speaking</a>
    <div class="dropdown-menu">
      <a class="dropdown-item" href="http://www.dabeaz.com/talks.html">Talks</a>
      <a class="dropdown-item" href="http://www.dabeaz.com/tutorials.html">Tutorials</a>
    </div>
  </li>

      <li class="nav-item">
        <a class="nav-link" href="http://www.dabeaz.com/software.html">Software</a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="https://forum.dabeaz.com/">Forum</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="http://www.dabeaz.com/about.html">About</a>
      </li>
    </ul>

    <a href="http://www.dabeaz.com/contact.html" aria-label="Search">Contact</a>

    <!--
    <form class="form-inline my-2 my-lg-0">
      <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
      <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
    </form>
    -->
  </div>
</nav>

<div class="container">

 <h1>A Curious Course on Coroutines and Concurrency</h1>
 
 <p>
 <b>Copyright (C) 2009, All Rights Reserved</b><br>
 <b>David Beazley</b><br>
 <b><a href="http://www.dabeaz.com/">http://www.dabeaz.com</a></b><br>
 </p>
 
 <p>
 Presented at PyCon 2009, March 25, 2009.
 </p>
 
 <h2>Related Tutorials</h2>
 
 <ul>
 <li><a href="http://www.dabeaz.com/generators">Generator Tricks for Systems Programmers</a>. Presented at PyCon 2008 (Chicago).</li>
 <li><a href="http://www.dabeaz.com/finalgenerator">Generators: The Final Frontier</a>. Presented at PyCon 2014 (Montreal).</li>
 </ul>
 
 <h2>Introduction</h2>
 
 <p>
 This tutorial is a practical exploration of using Python coroutines
 (extended generators) for solving problems in data processing, event
 handling, and concurrent programming.  The material starts off with
 generators and builds to writing a complete multitasking environment
 that can run thousands of concurrent tasks without using threads or
 using code based on event-driven callbacks (i.e., the "reactor"
 model).
 </p>
 
 <ul>
 <li><a href="http://www.dabeaz.com/coroutines/Coroutines.pdf">Presentation Slides</a> (PDF)</li>
 </ul>
 
 <p>
 <b>Note:</b> This tutorial might be viewed as a sequel to the tutorial 
 <a href="http://www.dabeaz.com/generators/index.html">Generator Tricks
 for System Programmers</a> I presented at PyCon'08 in Chicago.  If
 you have <em>never</em> used generator functions before, you might
 want to look at that presentation for more information.  This
 coroutine tutorial is meant to stand on its own, but you'll  get
 a more complete picture if you combine it with the generator presentation.
 </p>
 
 <h2>Requirements and Support Data Files</h2>
 
 <p>
 This tutorial requires the use of Python 2.5 or newer.  No third party
 modules are required.  Examples have been tested on both Unix and Windows XP.
 Examples will work on Python 3 as long as you fix all of the print statements.
 </p>
 
 <p>
 The following file contains some supporting data files that are used
 by the various code samples.  Download this to your machine to work with
 the examples that follow.
 </p>
 
 <ul>
 <li><a href="http://www.dabeaz.com/coroutines/coroutines.zip">coroutines.zip</a></li>
 </ul>
 
 <p>
 This download also includes a PDF of the lecture slides.
 </p>
 
 <h2>Code Samples</h2>
 
 <p>
 Here are various code samples from the course.  You can either cut and
 paste these from the browser or simply work with them directly in the
 "coroutines" directory. The order in which files are listed follow the
 course material.  These examples are written to run inside the
 "coroutines" directory that gets created when you unzip the above file
 containing the support data.
 </p>
 
 <h4>Part 1 : Introduction to Generators and Coroutines</h4>
 
 <ul>
 <li><a href="http://www.dabeaz.com/coroutines/countdown.py">countdown.py</a>.  A trivially simple generator function.</li>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/follow.py">follow.py</a>. A generator that follows lines
 written to a real-time log file (like Unix 'tail -f').  To run this
 program, you need to have a log-file to work with.  Run the
 program <a href="http://www.dabeaz.com/coroutines/logsim.py">logsim.py</a> to create a simulated
 web-server log (written in the file <tt>access-log</tt>).  Leave this program running in the background for the
 next few parts.</li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/pipeline.py">pipeline.py</a>.  An example of using generators to set up a simple processing pipeline.
 Print all server log entries containing the word 'python'.</li>
 <p></p>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/grep.py">grep.py</a>.  A first example of a coroutine function.  This function receives lines
 and prints out those that contain a substring.</li>
 <p></p>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/coroutine.py">coroutine.py</a>.  A decorator function that eliminates the need to call <tt>.next()</tt> when
 starting a coroutine.</li>
 <p></p>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/grepclose.py">grepclose.py</a>. An example of a coroutine that catches the <tt>close()</tt> operation.
 </li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/bogus.py">bogus.py</a>. An example of a bogus generator that generates and receives values (not a recommended
 coding style).</li>
 <p></p>
 
 </ul>
 
 <h4>Part 2 : Coroutines, Pipelines, and Dataflow</h4>
 
 <ul>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/cofollow.py">cofollow.py</a>.  A simple example of feeding data from a data source into a coroutine. This
 mirrors the 'tail -f' example from earlier.</li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/copipe.py">copipe.py</a>.  An example of setting up a processing pipeline with coroutines.</li>
 <p></p>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/cobroadcast.py">cobroadcast.py</a>.  An example of a coroutine broadcaster.  This fans a data stream out to
 multiple targets.</li>
 <p></p>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/cobroadcast2.py">cobroadcast2.py</a>.  An example of broadcasting with a slightly different data handling pattern.</li>
 <p></p>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/benchmark.py">benchmark.py</a>.  A small benchmark comparing the performance of sending data into a coroutine
 vs. sending data into an instance of a class.</li>
 <p></p>
 </ul>
 
 <h4>Part 3 : Coroutines and Event Dispatching</h4>
 
 <ul>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/basicsax.py">basicsax.py</a>.  A very basic example of the SAX API for parsing XML documents (does
 not involve coroutines).</li>
 <p></p>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/cosax.py">cosax.py</a>.  An example that pushes SAX events into a coroutine.</li>
 <p></p>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/buses.py">buses.py</a>.  An example of parsing and filtering XML data with a 
 series of connected coroutines.</li>
 <p></p>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/coexpat.py">coexpat.py</a>.  An XML parser that turns events generated by the expat XML library into
 coroutines.  Compare with <tt>cosax.py</tt> above.</li>
 <p></p>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/cxml/cxmlparse.c">cxml/cxmlparse.c</a>.  A bare-bones C
 extension module that uses the expat library and pushes events into
 coroutines.  To build this code on your own machine, you will need to
 first build and install expat and then use <tt>python setup.py
 build_ext --inplace</tt>.  Note: This main focus of this class is not
 C extension building so you might have to mess around with this to get
 it to work.  Key point: you can dispatch data into a coroutine
 directly from C.</li>
 <p></p>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/iterbus.py">iterbus.py</a>.  An example of incremental
 XML parsing with the ElementTree module (for comparison with
 coroutines).
 </li>
 <p></p>
 </ul>
 
 <h4>Part 4 : From Data Processing to Concurrent Programming</h4>
 
 <ul>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/cothread.py">cothread.py</a>.  A thread object that runs
 a coroutine.</li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/coprocess.py">coprocess.py</a>. An example of running a
 coroutine in a subprocess.  This example runs a separate
 program <a href="http://www.dabeaz.com/coroutines/busproc.py">busproc.py</a> in a subprocess and sends
 data to it.</li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/cocrash.py">cocrash.py</a>. An example of crashing a
 thread by having it send data into an already executing coroutine.
 Since this example depends on thread synchronization, it may
 occasionally "work" by accident.  Run it a few more times.</li>
 <p></p>
 
 </ul>
 
 <h4>Part 7 : Writing an Operating System</h4>
 
 <ul>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/pyos1.py">pyos1.py</a>. A simple object representing a "task."  It is a wrapper around
 a coroutine.</li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/pyos2.py">pyos2.py</a>. A simple task scheduler that alternates between
 tasks whenever they yield.</li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/taskcrash.py">taskcrash.py</a>. An example showing how the schedule crashes
 if one of the tasks terminates.</li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/pyos3.py">pyos3.py</a>. An improved scheduler that properly handles
 task termination.</li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/pyos4.py">pyos4.py</a>. A scheduler with support for "system calls."  </li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/pyos5.py">pyos5.py</a>. A scheduler with system calls for basic task
 creation and termination.</li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/pyos6.py">pyos6.py</a>. A scheduler that adds support for task waiting.</li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/echobad.py">echobad.py</a>. A broken example of trying to use coroutines
 to implement a multitasking network server.  It breaks due to blocking I/O operations.</li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/pyos7.py">pyos7.py</a>. A scheduler that adds support for I/O waiting.</li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/echogood.py">echogood.py</a>. A slightly modified version of the echo server
 above that properly handles blocking I/O.</li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/echogood2.py">echogood2.py</a>. An echo server without the "I'm alive" messages.</li>
 <p></p>
 </ul>
 
 <h4>Part 8 : The Problem with Subroutines and the Stack</h4>
 
 <ul>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/trampoline.py">trampoline.py</a>.  An example of "trampolining" between coroutines.</li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/pyos8.py">pyos8.py</a>.  The OS with an enhanced Task
 object that allows coroutines to transfer control to other coroutines
 like subroutines.</li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/echoserver.py">echoserver.py</a>. A concurrent echo server using coroutines.
 </li>
 <p></p>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/sockwrap.py">sockwrap.py</a>. An class wrapper that shows how you can emulate the
 socket interface with a collection of coroutine methods.</li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/echoserver2.py">echoserver2.py</a>. An echo server using the class-based interface.</li>
 <p></p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/twistedecho.py">twistedecho.py</a>. A basic echo server
 written for Twisted.  You will need to
 install <a href="http://twistedmatrix.com/">Twisted</a> to run this.
 One reason why I have included this here is that the low-level I/O
 handling is very similar. 
 Specifically, in our "operating system", I/O events are tied into task
 scheduling.  In Twisted, I/O events are tied into event handlers
 (Reactors).</li>
 <p></p>
 </ul>
 
 Part 9 : Final words
 
 <ul>
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/blaster.py">blaster.py</a>.  A very simple script that
 opens up 300 socket connections with an echo server and randomly
 blasts it with 1024 bytes messages.  The
 program <a href="http://www.dabeaz.com/coroutines/runblaster.py">runblaster.py</a> will run multiple
 copies of this program in different subprocesses to increase the load.
 </li>
 <p></p>
 
 <p>
 Note: these scripts are the same ones I used to do a basic benchmark
 on Twisted vs. Coroutines described in the handout.  The main goal of
 this class has not been performance measurement so you might want to play
 around with the scripts--changing different settings
 for the number of connections, number of processes, message size, etc.  To
 allow a large number of socket connections, you might have to fiddle
 with system settings.  For example, on my Mac, I first have to use
 'ulimit -n 1024' in the shell to change the number of file descriptors
 on the server (otherwise, only 256 connections can be handled).
 </p>
 
 <p>
 </p><li><a href="http://www.dabeaz.com/coroutines/echothread.py">echothread.py</a>.  A threaded implementation of
 the echo server--built using the SocketServer library module.   It is
 interesting to play around with the above benchmark script on coroutines and
 then try it on a threaded server.</li>
 <p></p>
 </ul>
 
 <p>
 </p><h4>Design Commentary</h4>
 
 <p>
 One of the most tricky parts of working with a language feature like 
 coroutines is figuring out how they should interact with other 
 program elements such as functions and classes.  If you look at various
 libraries and frameworks, you often find that they all vary slightly in
 how they address this issue.
 </p>
 
 <p>
 The design of the task scheduler I wrote for this class is strongly
 biased towards my prior experience teaching courses on Operating
 System design.  One of the most critical parts of writing an OS is
 both protecting the system and keeping user applications isolated.  In
 the sample code, the <tt>Scheduler</tt> class represents a kind of
 "operating system."  You will notice that the tasks defined in this
 course never directly interact with this scheduler (other than using
 yield to execute scheduler traps).  That is, they do not hold
 references to the scheduler object, they do not invoke methods on the
 scheduler, they do not inspect internal scheduler data, and they don't
 hold references to other tasks.  For all practical purposes, the
 scheduler and the tasks are two completely different execution
 domains.  There is a good reason for keeping this separation.  Namely
 it promotes a loose coupling between tasks and their execution
 environment.  One could imagine creating other kinds of task
 schedulers that run tasks within threads or subprocesses.  If you've
 set things up right and taken great care to promote the separation of
 tasks and scheduling, such schedulers would be able to run existing
 tasks without modification.  Of course, the devil is in the details
 :-).
 </p>
 
 <h4>Contact me</h4>
 
 <p>
 Concurrency is a topic that generally interests me.  I welcome all
 feedback, comments, and suggestions for improvement on this course
 material.  Please feel free to contact me by sending an email to
 "dave" at "dabeaz.com".
 </p>
 

</div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="./_A Curious Course on Coroutines and Concurrency_files/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="./_A Curious Course on Coroutines and Concurrency_files/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="./_A Curious Course on Coroutines and Concurrency_files/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
  

</body></html>